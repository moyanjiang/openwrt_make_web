# OpenWrtç¼–è¯‘å™¨ - ä¿®å¤ç¼–ç é—®é¢˜çš„Dockeré•œåƒ
FROM ubuntu:22.04

# è®¾ç½®ç¯å¢ƒå˜é‡ - é‡ç‚¹è§£å†³ç¼–ç é—®é¢˜
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=Asia/Shanghai
ENV LANG=zh_CN.UTF-8
ENV LC_ALL=zh_CN.UTF-8
ENV LC_CTYPE=zh_CN.UTF-8
ENV PYTHONIOENCODING=utf-8
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV PORT=5000

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å®‰è£…localeå’Œå­—ç¬¦ç¼–ç æ”¯æŒ
RUN apt-get update && apt-get install -y \
    locales \
    language-pack-zh-hans \
    && locale-gen zh_CN.UTF-8 \
    && update-locale LANG=zh_CN.UTF-8 \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# è®¾ç½®æ—¶åŒº
RUN ln -snf /usr/share/zoneinfo/$TZ /etc/localtime && echo $TZ > /etc/timezone

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    # Pythonç¯å¢ƒ
    python3 python3-pip python3-venv python3-dev python3-setuptools python3-wheel \
    # åŸºç¡€å·¥å…·
    curl wget git unzip vim nano htop tree \
    # ç½‘ç»œå·¥å…·
    iputils-ping netcat-openbsd \
    # ç¼–è¯‘å·¥å…·
    build-essential gcc g++ make cmake \
    # OpenWrtç¼–è¯‘ä¾èµ–
    libncurses5-dev libncursesw5-dev zlib1g-dev gawk gettext libssl-dev \
    xsltproc rsync subversion mercurial bzr ecj fastjar file \
    java-propose-classpath libelf-dev python3-distutils \
    swig aria2 libtinfo5 libgmp3-dev libmpc-dev libmpfr-dev \
    libusb-1.0-0-dev libusb-dev liblzma-dev libsnmp-dev libevent-dev \
    libavahi-client-dev libsqlite3-dev libpcre2-dev \
    # å­—ä½“æ”¯æŒ
    fonts-wqy-zenhei fonts-wqy-microhei \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN groupadd -r openwrt && \
    useradd -r -g openwrt -u 1000 -m -s /bin/bash openwrt

# å¤åˆ¶requirementsæ–‡ä»¶å¹¶å®‰è£…Pythonä¾èµ–
COPY requirements.txt /app/
RUN python3 -m pip install --upgrade pip setuptools wheel && \
    python3 -m pip install --no-cache-dir -r requirements.txt

# åˆ›å»ºç›®å½•ç»“æ„
RUN mkdir -p \
    /app/backend \
    /app/frontend \
    /app/workspace/users \
    /app/logs \
    /app/data \
    /app/config \
    /app/tmp

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY backend/ /app/backend/
COPY frontend/ /app/frontend/
COPY config/ /app/config/

# åˆ›å»ºä¿®å¤ç¼–ç çš„å¯åŠ¨è„šæœ¬
RUN cat > /app/start-fixed.py << 'EOF'
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import sys
import locale
import subprocess

# è®¾ç½®ç¼–ç ç¯å¢ƒ
os.environ['LANG'] = 'zh_CN.UTF-8'
os.environ['LC_ALL'] = 'zh_CN.UTF-8'
os.environ['PYTHONIOENCODING'] = 'utf-8'

# è®¾ç½®Pythoné»˜è®¤ç¼–ç 
if sys.version_info >= (3, 7):
    # Python 3.7+ é»˜è®¤ä½¿ç”¨UTF-8
    pass
else:
    # ä¸ºæ—§ç‰ˆæœ¬Pythonè®¾ç½®ç¼–ç 
    import codecs
    sys.stdout = codecs.getwriter('utf-8')(sys.stdout.buffer)
    sys.stderr = codecs.getwriter('utf-8')(sys.stderr.buffer)

# è®¾ç½®locale
try:
    locale.setlocale(locale.LC_ALL, 'zh_CN.UTF-8')
except locale.Error:
    try:
        locale.setlocale(locale.LC_ALL, 'en_US.UTF-8')
    except locale.Error:
        print("Warning: Could not set locale")

print("ğŸš€ Starting OpenWrt Compiler with encoding fixes...")
print(f"Locale: {locale.getlocale()}")
print(f"Default encoding: {sys.getdefaultencoding()}")
print(f"File system encoding: {sys.getfilesystemencoding()}")

# å¯åŠ¨Flaskåº”ç”¨
if __name__ == '__main__':
    # åˆ‡æ¢åˆ°backendç›®å½•
    os.chdir('/app/backend')
    
    # å¯åŠ¨åº”ç”¨
    from app import app
    app.run(
        host='0.0.0.0',
        port=int(os.environ.get('PORT', 5000)),
        debug=False,
        threaded=True
    )
EOF

# åˆ›å»ºç®€å•çš„Flaskåº”ç”¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
RUN if [ ! -f /app/backend/app.py ]; then \
    cat > /app/backend/app.py << 'EOF'
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import json
from flask import Flask, render_template_string, jsonify, request
from datetime import datetime

app = Flask(__name__)
app.config['JSON_AS_ASCII'] = False  # æ”¯æŒä¸­æ–‡JSON

# ä¸»é¡µæ¨¡æ¿
INDEX_TEMPLATE = '''
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenWrtç¼–è¯‘å™¨</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', 'SimHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        h1 { text-align: center; margin-bottom: 30px; }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .feature-card {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.2);
        }
        .status-ok { color: #4CAF50; }
        .status-warning { color: #FF9800; }
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 5px;
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        .btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ OpenWrtå›ºä»¶ç¼–è¯‘å™¨</h1>
        
        <div class="feature-grid">
            <div class="feature-card">
                <h3>ğŸ“± è®¾å¤‡æ”¯æŒ</h3>
                <p>æ”¯æŒä¸»æµè·¯ç”±å™¨è®¾å¤‡çš„å›ºä»¶ç¼–è¯‘</p>
                <ul>
                    <li>x86/x64 é€šç”¨è®¾å¤‡</li>
                    <li>ARM æ¶æ„è®¾å¤‡</li>
                    <li>MIPS è·¯ç”±å™¨</li>
                    <li>æ ‘è“æ´¾ç³»åˆ—</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h3>âš™ï¸ åŠŸèƒ½ç‰¹æ€§</h3>
                <p>å®Œæ•´çš„ç¼–è¯‘å’Œç®¡ç†åŠŸèƒ½</p>
                <ul>
                    <li>Webç‰ˆ menuconfig</li>
                    <li>å¤šç”¨æˆ·æ”¯æŒ</li>
                    <li>å®æ—¶ç¼–è¯‘æ—¥å¿—</li>
                    <li>è‡ªåŠ¨iStoreé›†æˆ</li>
                </ul>
            </div>
            
            <div class="feature-card">
                <h3>ğŸ”§ ç³»ç»ŸçŠ¶æ€</h3>
                <p>å½“å‰ç³»ç»Ÿè¿è¡ŒçŠ¶æ€</p>
                <div id="system-status">
                    <p class="status-ok">âœ… æœåŠ¡è¿è¡Œæ­£å¸¸</p>
                    <p class="status-ok">âœ… ç¼–ç é…ç½®æ­£ç¡®</p>
                    <p class="status-warning">âš ï¸ ç­‰å¾…ç”¨æˆ·é…ç½®</p>
                </div>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 30px;">
            <a href="/test-encoding" class="btn">ğŸ”§ ç¼–ç æµ‹è¯•</a>
            <a href="/api/health" class="btn">ğŸ’š å¥åº·æ£€æŸ¥</a>
            <a href="/api/status" class="btn">ğŸ“Š ç³»ç»ŸçŠ¶æ€</a>
        </div>
        
        <div style="text-align: center; margin-top: 20px; font-size: 14px; opacity: 0.8;">
            <p>å½“å‰æ—¶é—´: <span id="current-time"></span></p>
            <p>è®¿é—®åœ°å€: {{ request.url }}</p>
        </div>
    </div>

    <script>
        function updateTime() {
            document.getElementById('current-time').textContent = new Date().toLocaleString('zh-CN');
        }
        updateTime();
        setInterval(updateTime, 1000);
    </script>
</body>
</html>
'''

@app.route('/')
def index():
    return render_template_string(INDEX_TEMPLATE, request=request)

@app.route('/test-encoding')
def test_encoding():
    return '''
    <!DOCTYPE html>
    <html lang="zh-CN">
    <head>
        <meta charset="UTF-8">
        <title>ç¼–ç æµ‹è¯•</title>
    </head>
    <body>
        <h1>ä¸­æ–‡ç¼–ç æµ‹è¯•</h1>
        <p>å¦‚æœæ‚¨èƒ½çœ‹åˆ°è¿™äº›ä¸­æ–‡å­—ç¬¦ï¼Œè¯´æ˜ç¼–ç æ­£å¸¸ï¼š</p>
        <ul>
            <li>æµ‹è¯•å­—ç¬¦ï¼šä½ å¥½ä¸–ç•Œï¼</li>
            <li>æŠ€æœ¯æœ¯è¯­ï¼šè·¯ç”±å™¨ã€å›ºä»¶ã€ç¼–è¯‘</li>
            <li>ç‰¹æ®Šå­—ç¬¦ï¼šâ‘ â‘¡â‘¢â‘£â‘¤</li>
        </ul>
        <a href="/">è¿”å›ä¸»é¡µ</a>
    </body>
    </html>
    '''

@app.route('/api/health')
def health():
    return jsonify({
        'status': 'healthy',
        'message': 'æœåŠ¡è¿è¡Œæ­£å¸¸',
        'timestamp': datetime.now().isoformat(),
        'encoding': 'utf-8',
        'locale': os.environ.get('LANG', 'unknown')
    })

@app.route('/api/status')
def status():
    return jsonify({
        'service': 'OpenWrt Compiler',
        'version': '2.0.0',
        'status': 'è¿è¡Œä¸­',
        'features': [
            'å¤šç”¨æˆ·æ”¯æŒ',
            'Webç‰ˆmenuconfig',
            'å®æ—¶ç¼–è¯‘æ—¥å¿—',
            'iStoreé›†æˆ'
        ],
        'encoding': {
            'lang': os.environ.get('LANG'),
            'lc_all': os.environ.get('LC_ALL'),
            'python_encoding': os.environ.get('PYTHONIOENCODING')
        }
    })

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 5000)), debug=False)
EOF
fi

# è®¾ç½®æƒé™
RUN chmod +x /app/start-fixed.py && \
    chown -R openwrt:openwrt /app && \
    chmod 755 /app/workspace /app/logs /app/data && \
    chmod 777 /app/tmp

# åˆ›å»ºå¥åº·æ£€æŸ¥è„šæœ¬
RUN echo '#!/bin/bash\ncurl -f http://localhost:${PORT:-5000}/api/health || exit 1' > /healthcheck.sh && \
    chmod +x /healthcheck.sh

# æš´éœ²ç«¯å£
EXPOSE $PORT

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD /healthcheck.sh

# æ•°æ®å·
VOLUME ["/app/workspace", "/app/logs", "/app/data"]

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER openwrt

# å¯åŠ¨å‘½ä»¤
CMD ["python3", "/app/start-fixed.py"]
