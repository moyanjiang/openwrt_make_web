# OpenWrtç¼–è¯‘å™¨å‰ç«¯å¼€å‘ç¯å¢ƒDockerfile
FROM node:18-alpine as base

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=development

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache \
    python3 \
    py3-pip \
    curl \
    bash \
    git

# åˆ›å»ºåº”ç”¨ç›®å½•
WORKDIR /app

# å®‰è£…å…¨å±€å·¥å…·
RUN npm install -g \
    live-server \
    http-server \
    nodemon

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN cat > /app/start-dev.sh << 'EOF'
#!/bin/bash
echo "ğŸš€ å¯åŠ¨OpenWrtç¼–è¯‘å™¨å‰ç«¯å¼€å‘æœåŠ¡"
echo "ğŸ“ å‰ç«¯ç«¯å£: 9963"
echo "ğŸ”„ çƒ­é‡è½½: å¯ç”¨"
echo "ğŸ“ æœåŠ¡ç›®å½•: /app/frontend"

cd /app/frontend

# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
if command -v live-server >/dev/null 2>&1; then
    echo "ğŸŒ ä½¿ç”¨live-serverå¯åŠ¨..."
    live-server --port=9963 --host=0.0.0.0 --no-browser --wait=200
else
    echo "ğŸŒ ä½¿ç”¨http-serverå¯åŠ¨..."
    http-server -p 9963 -a 0.0.0.0 --cors
fi
EOF

RUN chmod +x /app/start-dev.sh

# æš´éœ²ç«¯å£
EXPOSE 9963 3001

# å¥åº·æ£€æŸ¥
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:9963/ || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["/app/start-dev.sh"]
